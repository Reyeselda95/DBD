SOLUCIÛN sesion12

-- EJERCICIO 1

ALTER TABLE MATERIAL 
MODIFY ESTADO CONSTRAINT CHECK_ESTADO CHECK (ESTADO IN ('NORMAL', 'PESIMO', 'GASTADO', 'OPTIMO')); 

-- EJERCICIO 2

ALTER TABLE CLIENTE
MODIFY TELEFONO NOT NULL;


 --EJERCICIO 3

create or replace
FUNCTION TARIFA(ELCODMAT CHAR) RETURN NUMBER
IS
AUXTARIFA TIPO.TARIFADIARIA%TYPE;
BEGIN
SELECT TARIFADIARIA INTO AUXTARIFA
FROM MATERIAL, TIPO 
WHERE TIPO = CODTIPO AND CODIGO=ELCODMAT;
RETURN(AUXTARIFA);
EXCEPTION
WHEN NO_DATA_FOUND THEN ESCRIBIR('NO EXISTE ESE MATERIAL');

END;

-- EJERCICIO 4

create or replace
PROCEDURE COMPROBAR(ELMATERIAL CHAR, LAFECHA DATE) IS
CURSOR C1 IS SELECT CODIGO, ESTADO FROM MATERIAL 
  WHERE ESTADO<>'PESIMO' AND TIPO= (SELECT TIPO FROM MATERIAL WHERE CODIGO=ELMATERIAL);
AUXESTADO MATERIAL.ESTADO%TYPE;
AUXTIPO MATERIAL.TIPO%TYPE;
ALQUILADO NUMBER(1);
AUX NUMBER(1);
LISTA NUMBER(5);

BEGIN
SELECT ESTADO, TIPO INTO AUXESTADO, AUXTIPO FROM MATERIAL WHERE CODIGO=ELMATERIAL;

IF (AUXESTADO<>'PESIMO') THEN
  SELECT COUNT(*) INTO ALQUILADO FROM ALQUILAR WHERE MATERIAL= ELMATERIAL AND FECHA=LAFECHA;
  IF (ALQUILADO=0) THEN ESCRIBIR('SE PUEDE RESERVAR');
  ELSE
  lista:=0;
  FOR RC1 IN C1 LOOP
   SELECT COUNT(*) into aux FROM ALQUILAR WHERE FECHA=LAFECHA AND MATERIAL=RC1.CODIGO;
   IF (AUX=0) THEN lista:=lista+1; ESCRIBIR(RC1.CODIGO||' -- '||RC1.ESTADO); END IF;
  END LOOP;
  IF (LISTA=0) THEN 
   escribir('SIN DISPONIBILIDAD');
   UPDATE TIPO SET COMENTARIO='MUY DEMANDADO' WHERE CODTIPO = AUXTIPO;
  END IF;
END IF;
END IF;
END;

--EJERCICIO 5

CREATE TRIGGER EJERCICIO5
AFTER UPDATE OF ESTADO ON MATERIAL
FOR EACH ROW
DECLARE AUXDESCRIPCION TIPO.DESCRIPCION%TYPE;
BEGIN
 IF (:NEW.ESTADO='PESIMO' AND :OLD.ESTADO='OPTIMO')
 THEN
   SELECT DESCRIPCION INTO AUXDESCRIPCION FROM TIPO WHERE CODTIPO=:NEW.TIPO;
   ESCRIBIR('El material '||:NEW.CODIGO||' QUE ES '||AUXDESCRIPCION||' ha pasado directamente de OPTIMO a PESIMO. Estudiar el deterioro.');
 END IF;
END;


-- EJERCICIO 6

create or replace
TRIGGER EJERCICIO6
AFTER INSERT ON SUMINISTRAR
FOR EACH ROW
DECLARE 
AUXTARIFADIARIA TIPO.TARIFADIARIA%TYPE;
BEGIN
 SELECT TARIFADIARIA INTO AUXTARIFADIARIA FROM TIPO WHERE CODTIPO=:NEW.TIPO;
 IF (:NEW.PRECIO>200*AUXTARIFADIARIA)
 THEN
  RAISE_APPLICATION_ERROR(-20100,'Precio muy elevado. No considerarlo');
 ELSE
  IF (:NEW.PRECIO<100*AUXTARIFADIARIA)
  THEN
    ESCRIBIR(:NEW.PROVEEDOR||' nos permite reducir la tarifa de '||:NEW.TIPO);
    UPDATE TIPO SET TARIFADIARIA=0.9*TARIFADIARIA WHERE CODTIPO=:NEW.TIPO;
  END IF;
 END IF;
END;
